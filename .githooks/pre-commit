#!/bin/bash

# ============================================
# AI Tech Recruiter - Pre-Commit Security Hook
# ============================================
# 
# This hook prevents committing sensitive data
# 
# Installation:
#   chmod +x .githooks/pre-commit
#   git config core.hooksPath .githooks
# 
# ============================================

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "╔════════════════════════════════════════════╗"
echo "║   AI Tech Recruiter - Security Check       ║"
echo "╚════════════════════════════════════════════╝"
echo -e "${NC}"

# Track if any issues found
ISSUES_FOUND=0

# =====================================
# 1. Check for .env file
# =====================================

echo -e "${BLUE}[1/6]${NC} Checking for .env file..."

if git diff --cached --name-only | grep -q "^\.env$"; then
    echo -e "${RED}✗ BLOCKED: .env file in commit!${NC}"
    echo -e "  ${YELLOW}→${NC} Remove .env from commit: git reset HEAD .env"
    ISSUES_FOUND=1
else
    echo -e "${GREEN}✓${NC} No .env file found"
fi

# =====================================
# 2. Check for API keys and tokens
# =====================================

echo -e "\n${BLUE}[2/6]${NC} Scanning for API keys and tokens..."

PATTERNS=(
    "api[_-]?key"
    "[0-9]{10}:[A-Za-z0-9_-]{35}"  # Telegram bot token
    "ghp_[a-zA-Z0-9]{36}"           # GitHub token
    "AIza[0-9A-Za-z_-]{35}"         # Google API
    "sk-[a-zA-Z0-9]{48}"            # OpenAI key
    "xox[baprs]-[0-9a-zA-Z-]+"      # Slack token
)

for pattern in "${PATTERNS[@]}"; do
    if git diff --cached | grep -iE "$pattern" > /dev/null; then
        echo -e "${RED}✗ BLOCKED: Potential API key/token detected!${NC}"
        echo -e "  ${YELLOW}Pattern:${NC} $pattern"
        ISSUES_FOUND=1
    fi
done

if [ $ISSUES_FOUND -eq 0 ]; then
    echo -e "${GREEN}✓${NC} No API keys/tokens detected"
fi

# =====================================
# 3. Check for email addresses
# =====================================

echo -e "\n${BLUE}[3/6]${NC} Checking for real email addresses..."

# Exclude example.com, test.com, demo.com
if git diff --cached | grep -E "[a-zA-Z0-9._%+-]+@(?!example\.com|test\.com|demo\.com)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" > /dev/null; then
    # Check if it's demo@example.com specifically
    if git diff --cached | grep "demo@example.com" > /dev/null; then
        echo -e "${RED}✗ BLOCKED: Placeholder email address detected!${NC}"
        echo -e "  ${YELLOW}→${NC} Replace with: EXCLUDE_PLACEHOLDER"        
        ISSUES_FOUND=1
    fi
fi

if [ $ISSUES_FOUND -eq 0 ]; then
    echo -e "${GREEN}✓${NC} No real email addresses found"
fi

# =====================================
# 4. Check for phone numbers
# =====================================

echo -e "\n${BLUE}[4/6]${NC} Checking for phone numbers..."

if git diff --cached | grep -E "\([0-9]{2}\) ?[0-9]{4,5}-[0-9]{4}" > /dev/null; then
    echo -e "${YELLOW}⚠${NC}  Warning: Phone numbers detected"
    echo -e "  ${YELLOW}→${NC} Consider using: (11) 98888-0000"
fi

# =====================================
# 5. Check for large files
# =====================================

echo -e "\n${BLUE}[5/6]${NC} Checking for large files..."

MAX_SIZE=5242880 # 5MB

git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ $size -gt $MAX_SIZE ]; then
            echo -e "${YELLOW}⚠${NC}  Warning: Large file detected: $file ($(($size/1024/1024))MB)"
            echo -e "  ${YELLOW}→${NC} Consider using Git LFS for large files"
        fi
    fi
done

# =====================================
# 6. Check for TODO/FIXME in production
# =====================================

echo -e "\n${BLUE}[6/6]${NC} Checking for TODO/FIXME comments..."

TODO_COUNT=$(git diff --cached | grep -c "TODO\|FIXME" || true)

if [ $TODO_COUNT -gt 0 ]; then
    echo -e "${YELLOW}⚠${NC}  Found $TODO_COUNT TODO/FIXME comments"
    echo -e "  ${YELLOW}→${NC} Review before committing to production"
fi

# =====================================
# SUMMARY
# =====================================

echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ $ISSUES_FOUND -eq 0 ]; then
    echo -e "${GREEN}✓ Security check passed!${NC}"
    echo -e "${GREEN}✓ Proceeding with commit...${NC}"
    exit 0
else
    echo -e "${RED}✗ Security check failed!${NC}"
    echo -e "${RED}✗ Commit blocked for security reasons${NC}"
    echo ""
    echo -e "${YELLOW}How to fix:${NC}"
    echo "  1. Remove sensitive data from staged files"
    echo "  2. Run: git reset HEAD <file>"
    echo "  3. Edit files to remove sensitive data"
    echo "  4. Stage files again: git add <file>"
    echo "  5. Try committing again"
    echo ""
    echo -e "${YELLOW}Or bypass this check (NOT RECOMMENDED):${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
